<!doctype html>
<html>
    <head>
        <title>Notification Sound Experiment (Phase 1)</title>
        <script src="https://unpkg.com/jspsych@7.3.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@1.1.3"></script>
        <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>

        <link
            href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css"
            rel="stylesheet"
            type="text/css"
        />

        <script src="stimuli.js"></script>
    </head>
    <body></body>
    <script>
        // 1. jsPsychの初期化
        const jsPsych = initJsPsych({
            on_finish: function () {
                // 実験終了時にデータをCSVとしてダウンロード
                jsPsych.data.get().localSave("csv", "experiment_data.csv");
            },
        });

        // タイムライン（実験の手順書）
        var timeline = [];

        // 2. 音声ファイルのプリロード（遅延防止）
        // stimuli変数(stimuli.jsの中身)からパスだけ抽出
        var audio_paths = stimuli.map((s) => s.stimulus);
        var preload = {
            type: jsPsychPreload,
            audio: audio_paths,
        };
        timeline.push(preload);

        // 3. ウェルカム画面
        var welcome = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            <h3>実験にご協力ありがとうございます。</h3>
            <p>これから短い通知音が流れます。</p>
            <p>音が聞こえたら、その音に対するあなたの印象を回答してください。</p>
            <p>スペースキーを押すと始まります。</p>
        `,
        };
        timeline.push(welcome);

        // 4. 実験トライアルの定義
        // 音を再生 -> 評価画面 という1セットの手順
        var trial_procedure = {
            timeline: [
                // (1) 注視点 (0.5秒)
                {
                    type: jsPsychHtmlKeyboardResponse,
                    stimulus: '<div style="font-size:60px;">+</div>',
                    choices: "NO_KEYS",
                    trial_duration: 500,
                },
                // (2) 音声再生 (聞き終わるまで待機)
                {
                    type: jsPsychAudioKeyboardResponse,
                    stimulus: jsPsych.timelineVariable("stimulus"),
                    choices: "NO_KEYS", // キー入力を受け付けず、再生終了を待つ
                    trial_ends_after_audio: true,
                },
                // (3) 評価画面 (SD法 / リッカート尺度)
                {
                    type: jsPsychSurveyLikert,
                    questions: [
                        {
                            prompt: "この音の「心地よさ」についてどう感じますか？",
                            labels: [
                                "非常に不快",
                                "不快",
                                "やや不快",
                                "どちらでもない",
                                "やや快",
                                "快",
                                "非常に快",
                            ],
                            name: "pleasantness",
                            required: true,
                        },
                        {
                            prompt: "この音の「煩わしさ」についてどう感じますか？",
                            labels: [
                                "全く煩わしくない",
                                "煩わしくない",
                                "あまり",
                                "普通",
                                "やや煩わしい",
                                "煩わしい",
                                "非常に煩わしい",
                            ],
                            name: "annoyance",
                            required: true,
                        },
                    ],
                    data: jsPsych.timelineVariable("data"), // 分析用にカテゴリ情報などを保存
                },
            ],
            timeline_variables: stimuli, // stimuli.js のリストを順に適用
            randomize_order: true, // 提示順序をランダムにする
        };
        timeline.push(trial_procedure);

        // 5. 終了画面
        var end_screen = {
            type: jsPsychHtmlKeyboardResponse,
            stimulus: `
            <p>実験はこれで終了です。</p>
            <p>ありがとうございました。</p>
            <p>データが自動的にダウンロードされます。</p>
        `,
        };
        timeline.push(end_screen);

        // 6. 実験開始
        jsPsych.run(timeline);
    </script>
</html>
